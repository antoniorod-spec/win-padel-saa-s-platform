// ============================================================
// WhinPadel - Prisma Schema
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  PLAYER
  CLUB
  ADMIN
}

enum Sex {
  M
  F
}

enum ClubStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TournamentCategory {
  A
  B
  C
}

enum TournamentFormat {
  ELIMINATION
  ROUND_ROBIN
  LEAGUE
  EXPRESS
}

enum TournamentStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Modality {
  VARONIL
  FEMENIL
  MIXTO
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  REJECTED
  REFUNDED
}

enum MatchWinner {
  TEAM_A
  TEAM_B
  NONE
}

enum CategoryChangeType {
  ASCENSION
  DESCENT
}

enum CategoryChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TournamentType {
  FULL
  BASIC
}

enum ExternalRegistrationType {
  URL
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  OTHER
}

enum ResultsValidationStatus {
  NOT_REQUIRED
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum ResultSubmissionType {
  MANUAL
  EXCEL
}

enum ResultFinalStage {
  CHAMPION
  RUNNER_UP
  SEMIFINAL
  QUARTERFINAL
  ROUND_OF_16
  ROUND_OF_32
  GROUP_STAGE
}

enum RankingScope {
  CITY
  NATIONAL
}

// ============================================================
// AUTH MODELS (NextAuth.js / Auth.js)
// ============================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  name          String?
  image         String?
  role          UserRole  @default(PLAYER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Auth.js relations
  accounts Account[]
  sessions Session[]

  // App relations
  player Player?
  club   Club?
  platformSettingsUpdated PlatformSetting[]
  associationsOwned Association[] @relation("AssociationOwner")
  resultSubmissions TournamentResultSubmission[]
  validatedPlayerAssociations PlayerAssociation[]

  @@map("users")
}

model PlatformSetting {
  id                          String   @id @default("global")
  homeSponsorBannerEnabled    Boolean  @default(false)
  homeSponsorBannerImageUrl   String?
  homeSponsorBannerLinkUrl    String?
  homeSponsorBannerTitle      String?
  updatedByUserId             String?
  updatedAt                   DateTime @updatedAt

  updatedByUser User? @relation(fields: [updatedByUserId], references: [id], onDelete: SetNull)

  @@map("platform_settings")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================
// PLAYER
// ============================================================

model Player {
  id        String   @id @default(cuid())
  userId    String   @unique
  firstName String
  lastName  String
  city      String
  state     String?
  country   String   @default("MX")
  sex       Sex
  age       Int?
  phone     String?
  birthDate DateTime?
  documentType   String?
  documentNumber String?
  dominantHand   String?
  courtPosition  String?
  starShot       String?
  playStyle      String?
  preferredMatchType String?
  playsMixed     Boolean   @default(false)
  preferredSchedule String?
  preferredAgeRange String?
  bio       String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Registrations where this player is player1
  registrationsAsPlayer1 TournamentRegistration[] @relation("Player1Registrations")
  // Registrations where this player is player2
  registrationsAsPlayer2 TournamentRegistration[] @relation("Player2Registrations")
  importedRecord ImportedPlayer?

  rankings        Ranking[]
  categoryChanges CategoryChange[]
  associationMemberships PlayerAssociation[]
  resultRowsAsPlayer1 TournamentResultRow[] @relation("ResultRowPlayer1")
  resultRowsAsPlayer2 TournamentResultRow[] @relation("ResultRowPlayer2")

  @@map("players")
}

// ============================================================
// CLUB
// ============================================================

model Club {
  id            String     @id @default(cuid())
  userId        String     @unique
  
  // Datos del Club (Paso 2)
  name          String                    // Nombre comercial
  legalName     String?                   // Razón social
  rfc           String                    // RFC obligatorio
  phone         String                    // Teléfono del club
  email         String?                   // Email del club (puede ser diferente al de registro)
  website       String?                   // Sitio web
  
  // Datos del Responsable/Contacto (Paso 1)
  contactName     String                  // Nombre completo del responsable
  contactPhone    String                  // Teléfono del responsable
  contactEmail    String?                 // Email del responsable (opcional)
  contactPosition String?                 // Cargo (Gerente, Dueño, Administrador, etc.)
  
  // Ubicación (Paso 3)
  country       String     @default("MX")
  state         String                    // Estado/Provincia
  city          String                    // Ciudad
  address       String                    // Dirección completa
  postalCode    String?                   // Código postal
  neighborhood  String?                   // Colonia/Barrio
  latitude      Float?                    // Coordenada para mapas
  longitude     Float?                    // Coordenada para mapas
  
  // Instalaciones (Paso 4)
  indoorCourts  Int        @default(0)    // Canchas interiores
  outdoorCourts Int        @default(0)    // Canchas exteriores
  courts        Int        @default(0)    // Total (auto-calculado)
  courtSurface  String?                   // Tipo de superficie (Césped sintético, Cristal, Panorámica)
  courtSurfaces Json?                     // Multiples superficies seleccionables
  
  // Servicios Adicionales (Paso 5)
  hasParking          Boolean @default(false)  // Estacionamiento
  hasLockers          Boolean @default(false)  // Vestidores
  hasShowers          Boolean @default(false)  // Regaderas
  hasCafeteria        Boolean @default(false)  // Cafetería/Snack bar
  hasProShop          Boolean @default(false)  // Tienda de equipamiento
  hasLighting         Boolean @default(false)  // Iluminación nocturna
  hasAirConditioning  Boolean @default(false)  // Aire acondicionado (interiores)
  operatingHours      String?                  // Horario de operación
  weeklySchedule      Json?                    // Horario semanal por dia con bloques
  priceRange          String?                  // Rango de precios
  acceptsOnlineBooking Boolean @default(false) // Acepta reservaciones online
  services            Json?                    // Servicios personalizados adicionales
  
  // Redes sociales (opcionales)
  facebook      String?
  instagram     String?
  tiktok        String?
  youtube       String?
  linkedin      String?
  x             String?
  whatsapp      String?
  
  // Sistema
  status        ClubStatus @default(PENDING)
  rating        Float      @default(0)
  logoUrl       String?                   // Se puede agregar después
  photos        Json?                     // Array de URLs, se pueden agregar después
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  tournaments Tournament[]
  news        ClubNews[]
  importBatches TournamentImportBatch[]
  importedPlayers ImportedPlayer[]
  resultRows  TournamentResultRow[]

  @@map("clubs")
}

model ClubNews {
  id            String   @id @default(cuid())
  clubId         String
  title          String
  content        String
  coverImageUrl  String?
  published      Boolean  @default(false)
  publishedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId, published, publishedAt])
  @@map("club_news")
}

// ============================================================
// TOURNAMENT
// ============================================================

model Tournament {
  id               String           @id @default(cuid())
  clubId           String
  name             String
  description      String?
  venue            String?
  startDate        DateTime
  endDate          DateTime
  category         TournamentCategory
  format           TournamentFormat
  type             TournamentType    @default(FULL)
  prize            String?
  sponsorName      String?
  sponsorLogoUrl   String?
  logoUrl          String?
  images           Json?
  news             Json?
  inscriptionPrice Decimal          @default(0) @db.Decimal(10, 2)
  maxTeams         Int              @default(64)
  rules            Json?
  registrationDeadline DateTime?
  externalRegistrationType ExternalRegistrationType?
  externalRegistrationLink String?
  posterUrl         String?
  affectsRanking    Boolean          @default(true)
  resultsValidationStatus ResultsValidationStatus @default(NOT_REQUIRED)
  validatedByAssociationId String?
  validatedAt       DateTime?
  validationNotes   String?
  status           TournamentStatus @default(DRAFT)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  club       Club                  @relation(fields: [clubId], references: [id], onDelete: Cascade)
  validatedByAssociation Association? @relation("AssociationValidatedTournaments", fields: [validatedByAssociationId], references: [id], onDelete: SetNull)
  modalities TournamentModality[]
  importBatches TournamentImportBatch[]
  importedEntries ImportedTournamentEntry[]
  resultSubmissions TournamentResultSubmission[]
  resultRows TournamentResultRow[]

  @@map("tournaments")
}

model TournamentImportBatch {
  id                 String   @id @default(cuid())
  tournamentId       String
  tournamentModalityId String?
  sourceClubId       String
  fileName           String
  importType         String // players | pairs
  totalRows          Int      @default(0)
  importedRows       Int      @default(0)
  failedRows         Int      @default(0)
  createdAt          DateTime @default(now())

  tournament         Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  sourceClub         Club       @relation(fields: [sourceClubId], references: [id], onDelete: Cascade)
  importedEntries    ImportedTournamentEntry[]

  @@map("tournament_import_batches")
}

model ImportedPlayer {
  id                 String   @id @default(cuid())
  firstName          String
  lastName           String
  fullNameNormalized String
  phone              String?
  email              String?
  sex                Sex?
  city               String?
  country            String   @default("MX")
  sourceClubId       String?
  linkedPlayerId     String?  @unique
  linkStatus         String   @default("PENDING") // pending | linked | conflict
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  sourceClub         Club?    @relation(fields: [sourceClubId], references: [id], onDelete: SetNull)
  linkedPlayer       Player?  @relation(fields: [linkedPlayerId], references: [id], onDelete: SetNull)
  entriesAsPlayer1   ImportedTournamentEntry[] @relation("ImportedEntryPlayer1")
  entriesAsPlayer2   ImportedTournamentEntry[] @relation("ImportedEntryPlayer2")

  @@index([phone, fullNameNormalized])
  @@map("imported_players")
}

model ImportedTournamentEntry {
  id                   String   @id @default(cuid())
  importBatchId        String
  tournamentId         String
  tournamentModalityId String
  importedPlayer1Id    String
  importedPlayer2Id    String
  linkedRegistrationId String?  @unique
  seed                 Int?
  createdAt            DateTime @default(now())

  importBatch          TournamentImportBatch @relation(fields: [importBatchId], references: [id], onDelete: Cascade)
  tournament           Tournament           @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentModality   TournamentModality   @relation(fields: [tournamentModalityId], references: [id], onDelete: Cascade)
  importedPlayer1      ImportedPlayer       @relation("ImportedEntryPlayer1", fields: [importedPlayer1Id], references: [id], onDelete: Cascade)
  importedPlayer2      ImportedPlayer       @relation("ImportedEntryPlayer2", fields: [importedPlayer2Id], references: [id], onDelete: Cascade)
  linkedRegistration   TournamentRegistration? @relation(fields: [linkedRegistrationId], references: [id], onDelete: SetNull)

  @@unique([tournamentModalityId, importedPlayer1Id, importedPlayer2Id])
  @@map("imported_tournament_entries")
}

// ============================================================
// TOURNAMENT MODALITY (e.g., Varonil 4ta within a tournament)
// ============================================================

model TournamentModality {
  id           String   @id @default(cuid())
  tournamentId String
  modality     Modality
  category     String   // e.g. "1ra", "2da", "3ra", "4ta", "5ta", "6ta", "A", "B", "C", "D"

  tournament    Tournament               @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  registrations TournamentRegistration[]
  matches       Match[]
  importedEntries ImportedTournamentEntry[]
  resultSubmissions TournamentResultSubmission[]

  @@unique([tournamentId, modality, category])
  @@map("tournament_modalities")
}

// ============================================================
// TOURNAMENT REGISTRATION (a pair of players in a modality)
// ============================================================

model TournamentRegistration {
  id                    String        @id @default(cuid())
  tournamentModalityId  String
  player1Id             String
  player2Id             String
  seed                  Int?
  paymentStatus         PaymentStatus @default(PENDING)
  paymentAmount         Decimal       @default(0) @db.Decimal(10, 2)
  paymentReference      String?
  registeredAt          DateTime      @default(now())

  tournamentModality TournamentModality @relation(fields: [tournamentModalityId], references: [id], onDelete: Cascade)
  player1            Player             @relation("Player1Registrations", fields: [player1Id], references: [id])
  player2            Player             @relation("Player2Registrations", fields: [player2Id], references: [id])

  matchesAsTeamA Match[] @relation("TeamAMatches")
  matchesAsTeamB Match[] @relation("TeamBMatches")
  importedEntry  ImportedTournamentEntry?

  @@unique([tournamentModalityId, player1Id, player2Id])
  @@map("tournament_registrations")
}

// ============================================================
// MATCH
// ============================================================

model Match {
  id                     String      @id @default(cuid())
  tournamentModalityId   String
  roundName              String      // e.g. "Cuartos de Final", "Semifinales", "Final"
  roundOrder             Int         // 1 = first round, 2 = quarters, etc.
  matchOrder             Int         // order within the round
  teamARegistrationId    String?
  teamBRegistrationId    String?
  winner                 MatchWinner @default(NONE)
  scores                 Json?       // e.g. [{ setA: 6, setB: 3 }, { setA: 6, setB: 4 }]
  playedAt               DateTime?
  court                  String?
  scheduledAt            DateTime?
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt

  tournamentModality TournamentModality  @relation(fields: [tournamentModalityId], references: [id], onDelete: Cascade)
  teamARegistration  TournamentRegistration? @relation("TeamAMatches", fields: [teamARegistrationId], references: [id])
  teamBRegistration  TournamentRegistration? @relation("TeamBMatches", fields: [teamBRegistrationId], references: [id])

  @@map("matches")
}

// ============================================================
// RANKING (per player, per modality, per category)
// ============================================================

model Ranking {
  id       String   @id @default(cuid())
  playerId String
  modality Modality
  category String   // e.g. "1ra", "2da", "3ra", "4ta", "5ta", "6ta", "A", "B", "C", "D"
  scope    RankingScope @default(CITY)
  associationId String?
  points   Int      @default(0)
  played   Int      @default(0)
  wins     Int      @default(0)
  losses   Int      @default(0)

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  association Association? @relation(fields: [associationId], references: [id], onDelete: SetNull)

  @@unique([playerId, modality, category, scope])
  @@map("rankings")
}

// ============================================================
// CATEGORY CHANGE (ascension/descent review)
// ============================================================

model CategoryChange {
  id           String               @id @default(cuid())
  playerId     String
  modality     Modality
  fromCategory String
  toCategory   String
  type         CategoryChangeType
  status       CategoryChangeStatus @default(PENDING)
  reason       String?
  autoApproved Boolean              @default(false)
  reviewedBy   String?
  reviewedAt   DateTime?
  createdAt    DateTime             @default(now())

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@map("category_changes")
}

model Association {
  id        String   @id @default(cuid())
  name      String
  city      String
  state     String?
  country   String   @default("MX")
  status    String   @default("ACTIVE")
  ownerUserId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerUser User? @relation("AssociationOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  memberships PlayerAssociation[]
  rankings   Ranking[]
  validatedTournaments Tournament[] @relation("AssociationValidatedTournaments")
  validatedSubmissions TournamentResultSubmission[] @relation("AssociationValidatedSubmissions")

  @@map("associations")
}

model PlayerAssociation {
  id            String   @id @default(cuid())
  playerId      String
  associationId String
  status        String   @default("PENDING")
  validatedAt   DateTime?
  validatedByUserId String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  association Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  validatedByUser User?   @relation(fields: [validatedByUserId], references: [id], onDelete: SetNull)

  @@unique([playerId, associationId])
  @@map("player_associations")
}

model TournamentResultSubmission {
  id             String   @id @default(cuid())
  tournamentId   String
  tournamentModalityId String?
  submittedByUserId String
  submissionType ResultSubmissionType
  fileName       String?
  status         ResultsValidationStatus @default(PENDING_REVIEW)
  validatedByAssociationId String?
  validatedAt    DateTime?
  validationNotes String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentModality TournamentModality? @relation(fields: [tournamentModalityId], references: [id], onDelete: SetNull)
  submittedByUser User @relation(fields: [submittedByUserId], references: [id], onDelete: Cascade)
  validatedByAssociation Association? @relation("AssociationValidatedSubmissions", fields: [validatedByAssociationId], references: [id], onDelete: SetNull)
  rows TournamentResultRow[]

  @@map("tournament_result_submissions")
}

model TournamentResultRow {
  id            String   @id @default(cuid())
  submissionId  String
  tournamentId  String
  modality      Modality
  category      String
  finalStage    ResultFinalStage
  player1Id     String?
  player2Id     String?
  importedPlayer1Name String?
  importedPlayer2Name String?
  sourceClubId  String?
  createdAt     DateTime @default(now())

  submission TournamentResultSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  player1    Player?    @relation("ResultRowPlayer1", fields: [player1Id], references: [id], onDelete: SetNull)
  player2    Player?    @relation("ResultRowPlayer2", fields: [player2Id], references: [id], onDelete: SetNull)
  sourceClub Club?      @relation(fields: [sourceClubId], references: [id], onDelete: SetNull)

  @@index([tournamentId, modality, category, finalStage])
  @@map("tournament_result_rows")
}
